<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard â€“ EduLearn</title>
    <link rel="stylesheet" href="css/style.css" />
</head>

<body>
    <div class="dashboard-layout">

        <!-- â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <div class="logo-icon">ğŸ“</div>
                <span>EduLearn</span>
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-section">Main</div>
                <div class="sidebar-link active" onclick="showSection('overview')"><span class="sidebar-icon">ğŸ“Š</span>
                    Overview</div>
                <div class="sidebar-link" onclick="showSection('courses')"><span class="sidebar-icon">ğŸ“š</span> Browse
                    Courses</div>
                <div class="sidebar-link" onclick="showSection('enrollments')"><span class="sidebar-icon">ğŸ“‹</span> My
                    Enrollments</div>

                <div class="sidebar-section">Academic</div>
                <div class="sidebar-link" onclick="showSection('grades')"><span class="sidebar-icon">ğŸ†</span> My Grades
                </div>
                <div class="sidebar-link" onclick="showSection('record')"><span class="sidebar-icon">ğŸ“œ</span> Academic
                    Record</div>

                <div class="sidebar-section">Account</div>
                <div class="sidebar-link" onclick="handleLogout()"><span class="sidebar-icon">ğŸšª</span> Logout</div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="sidebarAvatar">?</div>
                    <div>
                        <div class="user-name" id="sidebarName">Loading...</div>
                        <div class="user-role">Student</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <main class="dashboard-main">

            <!-- Overview -->
            <div id="sec-overview">
                <div class="dashboard-header">
                    <h1>Good evening, <span id="welcomeName" class="text-gradient">Student</span> ğŸ‘‹</h1>
                    <p>Track your progress, credits, and learning journey</p>
                </div>
                <div class="stats-row" id="statsRow">
                    <div class="stat-card glass">
                        <div class="stat-card-label">Credits Earned</div>
                        <div class="stat-card-value text-gradient" id="statCred">â€“</div>
                        <div class="stat-card-sub">NEP Credit Bank</div>
                    </div>
                    <div class="stat-card glass">
                        <div class="stat-card-label">Courses Enrolled</div>
                        <div class="stat-card-value text-gradient" id="statEnroll">â€“</div>
                        <div class="stat-card-sub">Active enrollments</div>
                    </div>
                    <div class="stat-card glass">
                        <div class="stat-card-label">CGPA</div>
                        <div class="stat-card-value text-gradient" id="statCgpa">â€“</div>
                        <div class="stat-card-sub">10-point scale</div>
                    </div>
                    <div class="stat-card glass">
                        <div class="stat-card-label">Skills Acquired</div>
                        <div class="stat-card-value text-gradient" id="statSkills">â€“</div>
                        <div class="stat-card-sub">From all courses</div>
                    </div>
                </div>
                <div class="dashboard-grid">
                    <div class="panel glass">
                        <div class="panel-header"><span class="panel-title">ğŸ“‹ Active Enrollments</span><button
                                class="btn btn-outline btn-sm" onclick="showSection('courses')">+ Enroll</button></div>
                        <div id="enrollPreview">
                            <div class="spinner"></div>
                        </div>
                    </div>
                    <div class="panel glass">
                        <div class="panel-header"><span class="panel-title">ğŸ† Recent Grades</span><button
                                class="btn btn-ghost btn-sm" onclick="showSection('grades')">View All</button></div>
                        <div id="gradesPreview">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Browse Courses -->
            <div id="sec-courses" style="display:none;">
                <div class="dashboard-header">
                    <h1>Browse <span class="text-gradient">Courses</span></h1>
                    <p>Discover NEP-aligned, skill-tagged courses</p>
                </div>
                <div style="display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap;">
                    <input id="courseSearch" class="form-control" style="max-width:280px;"
                        placeholder="Search courses..." />
                    <select id="categoryFilter" class="form-control" style="max-width:180px;">
                        <option value="">All Categories</option>
                        <option value="core">Core</option>
                        <option value="elective">Elective</option>
                        <option value="multidisciplinary">Multidisciplinary</option>
                        <option value="skill-enhancement">Skill Enhancement</option>
                        <option value="vocational">Vocational</option>
                    </select>
                    <button class="btn btn-primary btn-sm" onclick="loadAllCourses()">Search</button>
                </div>
                <div class="courses-grid" id="allCoursesGrid">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- My Enrollments -->
            <div id="sec-enrollments" style="display:none;">
                <div class="dashboard-header">
                    <h1>My <span class="text-gradient">Enrollments</span></h1>
                    <p>Track your course progress</p>
                </div>
                <div id="enrollmentsList">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- Grades -->
            <div id="sec-grades" style="display:none;">
                <div class="dashboard-header">
                    <h1>My <span class="text-gradient">Grades</span></h1>
                    <p>NEP 10-point grading scale</p>
                </div>
                <div class="panel glass">
                    <table class="grade-table" id="gradesTable">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Code</th>
                                <th>Marks</th>
                                <th>Grade</th>
                                <th>Points</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody id="gradesTbody">
                            <tr>
                                <td colspan="6" style="text-align:center;padding:24px;">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Academic Record -->
            <div id="sec-record" style="display:none;">
                <div class="dashboard-header">
                    <h1>Academic <span class="text-gradient">Record</span></h1>
                    <p>Your digital transcript & credit portfolio</p>
                </div>
                <div id="academicRecord">
                    <div class="spinner"></div>
                </div>
            </div>

        </main>
    </div>

    <!-- Course Detail Modal -->
    <div class="modal-overlay" id="courseModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Course Details</h3>
                <button class="modal-close" onclick="closeModal()">âœ•</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        const user = requireAuth(['student']);
        if (!user) throw new Error('redirect');

        // Init UI
        document.getElementById('sidebarAvatar').textContent = user.name[0].toUpperCase();
        document.getElementById('sidebarName').textContent = user.name;
        document.getElementById('welcomeName').textContent = user.name.split(' ')[0];

        // Section switch
        const sections = ['overview', 'courses', 'enrollments', 'grades', 'record'];
        function showSection(id) {
            sections.forEach(s => {
                document.getElementById(`sec-${s}`).style.display = s === id ? 'block' : 'none';
            });
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            event?.target?.closest('.sidebar-link')?.classList.add('active');
            if (id === 'courses') loadAllCourses();
            if (id === 'enrollments') loadEnrollments();
            if (id === 'grades') loadGrades();
            if (id === 'record') loadAcademicRecord();
        }

        function handleLogout() { clearAuth(); window.location.href = 'index.html'; }

        // â”€â”€ Load Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadOverview() {
            try {
                const [enrollRes, gradeRes, recRes] = await Promise.all([
                    Enrollments.mine(),
                    Grades.mine(),
                    AcademicRecords.mine().catch(() => null),
                ]);

                const active = enrollRes.data.filter(e => e.status === 'active');
                document.getElementById('statCred').textContent = user.creditsEarned ?? 0;
                document.getElementById('statEnroll').textContent = active.length;
                document.getElementById('statCgpa').textContent = recRes?.data?.cgpa?.toFixed(1) ?? 'â€“';
                document.getElementById('statSkills').textContent = recRes?.data?.skillsAcquired?.length ?? 'â€“';

                // Preview enrollments
                const ep = document.getElementById('enrollPreview');
                ep.innerHTML = active.length === 0
                    ? `<p style="color:var(--text-muted);text-align:center;padding:20px;">No active enrollments. <button class="btn btn-primary btn-sm" onclick="showSection('courses')">Browse Courses</button></p>`
                    : active.slice(0, 4).map(e => `
          <div class="enroll-item">
            <div class="enroll-item-header">
              <h4>${e.course?.name || 'Unknown'}</h4>
              <span style="font-size:0.8rem;color:var(--primary-light)">${e.progressPercentage}%</span>
            </div>
            <div class="enroll-progress-bar"><div class="enroll-progress-fill" style="width:${e.progressPercentage}%"></div></div>
            <div class="enroll-meta">
              <span>${e.course?.courseCode || ''}</span>
              <span>â­ ${e.course?.credits || 0} Credits</span>
            </div>
          </div>`).join('');

                // Preview grades
                const gp = document.getElementById('gradesPreview');
                gp.innerHTML = gradeRes.data.length === 0
                    ? `<p style="color:var(--text-muted);text-align:center;padding:20px;">No grades yet.</p>`
                    : `<table class="grade-table"><thead><tr><th>Course</th><th>Grade</th><th>Points</th></tr></thead><tbody>
            ${gradeRes.data.slice(0, 5).map(g => `<tr>
              <td>${g.course?.name || 'â€“'}</td>
              <td><span class="grade-badge grade-${(g.letterGrade || '').replace('+', 'p')}">${g.letterGrade || 'â€“'}</span></td>
              <td>${g.gradePoint ?? 'â€“'}</td>
            </tr>`).join('')}
           </tbody></table>`;
            } catch (err) {
                console.error(err);
            }
        }

        // â”€â”€ Browse Courses â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadAllCourses() {
            const grid = document.getElementById('allCoursesGrid');
            grid.innerHTML = '<div class="spinner"></div>';
            const search = document.getElementById('courseSearch')?.value || '';
            const category = document.getElementById('categoryFilter')?.value || '';
            let params = 'limit=20';
            if (search) params += `&search=${encodeURIComponent(search)}`;
            if (category) params += `&category=${category}`;
            try {
                const res = await Courses.list(params);
                if (!res.data.length) { grid.innerHTML = '<p style="text-align:center;padding:40px;color:var(--text-muted)">No courses found.</p>'; return; }
                grid.innerHTML = res.data.map(c => `
        <div class="course-card glass" onclick="openCourseModal('${c._id}','${encodeURIComponent(JSON.stringify(c))}')">
          <div class="course-header">
            <span class="course-category">${c.category || 'core'}</span>
            <span class="course-credits">â­ ${c.credits}</span>
          </div>
          <h3>${c.name}</h3>
          <p>${c.description}</p>
          <div class="course-skills">${(c.skills || []).slice(0, 3).map(s => `<span class="skill-tag">${s}</span>`).join('')}</div>
          <div class="course-footer">
            <div class="faculty-name"><div class="faculty-avatar">${(c.faculty?.name || '?')[0]}</div>${c.faculty?.name || 'Faculty'}</div>
            <button class="btn btn-primary btn-sm" onclick="event.stopPropagation();enrollNow('${c._id}')">Enroll</button>
          </div>
        </div>`).join('');
            } catch (e) { grid.innerHTML = `<p style="text-align:center;color:var(--danger)">Error: ${e.message}</p>`; }
        }

        async function enrollNow(courseId) {
            try {
                await Enrollments.enroll(courseId);
                alert('âœ… Enrolled successfully!');
                loadOverview();
            } catch (e) { alert('âŒ ' + e.message); }
        }

        // â”€â”€ Enrollments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadEnrollments() {
            const el = document.getElementById('enrollmentsList');
            el.innerHTML = '<div class="spinner"></div>';
            try {
                const res = await Enrollments.mine();
                if (!res.data.length) { el.innerHTML = '<p style="text-align:center;padding:40px;color:var(--text-muted)">No enrollments yet.</p>'; return; }
                el.innerHTML = `<div style="display:flex;flex-direction:column;gap:16px;">
        ${res.data.map(e => `
        <div class="panel glass">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;">
            <div>
              <h3 style="font-size:1.05rem;">${e.course?.name || 'â€“'}</h3>
              <div style="display:flex;gap:12px;margin-top:6px;">
                <span class="skill-tag">${e.course?.courseCode || ''}</span>
                <span class="course-credits">â­ ${e.course?.credits || 0} Credits</span>
                <span class="badge" style="font-size:0.72rem;">${e.status}</span>
              </div>
            </div>
            <div style="text-align:right;">
              <div style="font-size:1.5rem;font-weight:700;" class="text-gradient">${e.progressPercentage}%</div>
              <div style="font-size:0.75rem;color:var(--text-muted)">Complete</div>
            </div>
          </div>
          <div class="enroll-progress-bar" style="height:10px;margin-bottom:12px;"><div class="enroll-progress-fill" style="width:${e.progressPercentage}%"></div></div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-outline btn-sm" onclick="updateProgress('${e._id}',${e.progressPercentage})">Update Progress</button>
            ${e.status === 'active' ? `<button class="btn btn-ghost btn-sm" style="color:var(--danger)" onclick="dropCourse('${e._id}')">Drop Course</button>` : ''}
          </div>
        </div>`).join('')}
      </div>`;
            } catch (e) { el.innerHTML = `<p style="color:var(--danger)">${e.message}</p>`; }
        }

        async function updateProgress(id, current) {
            const val = prompt(`Current progress: ${current}%\nEnter new progress (0-100):`, current);
            if (val === null) return;
            const num = parseInt(val);
            if (isNaN(num) || num < 0 || num > 100) { alert('Enter a valid number 0â€“100'); return; }
            try {
                await Enrollments.updateProgress(id, { progressPercentage: num });
                loadEnrollments();
                loadOverview();
            } catch (e) { alert('âŒ ' + e.message); }
        }

        async function dropCourse(id) {
            if (!confirm('Are you sure you want to drop this course?')) return;
            try { await Enrollments.drop(id); loadEnrollments(); loadOverview(); }
            catch (e) { alert('âŒ ' + e.message); }
        }

        // â”€â”€ Grades â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadGrades() {
            const tbody = document.getElementById('gradesTbody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;"><div class="spinner"></div></td></tr>';
            try {
                const res = await Grades.mine();
                if (!res.data.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;color:var(--text-muted)">No grades yet.</td></tr>'; return; }
                tbody.innerHTML = res.data.map(g => `<tr>
        <td>${g.course?.name || 'â€“'}</td>
        <td style="color:var(--text-muted)">${g.course?.courseCode || 'â€“'}</td>
        <td>${g.marksObtained}/100</td>
        <td><span class="grade-badge grade-${(g.letterGrade || 'F').replace('+', 'p')}">${g.letterGrade || 'F'}</span></td>
        <td style="font-weight:700">${g.gradePoint ?? 0}</td>
        <td style="text-transform:capitalize;color:var(--text-muted)">${g.assessmentType || 'â€“'}</td>
      </tr>`).join('');
            } catch (e) { tbody.innerHTML = `<tr><td colspan="6" style="color:var(--danger);text-align:center;padding:20px;">${e.message}</td></tr>`; }
        }

        // â”€â”€ Academic Record â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadAcademicRecord() {
            const el = document.getElementById('academicRecord');
            el.innerHTML = '<div class="spinner"></div>';
            try {
                const res = await AcademicRecords.mine();
                const r = res.data;
                el.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:28px;">
          <div class="stat-card glass"><div class="stat-card-label">CGPA</div><div class="stat-card-value text-gradient">${r.cgpa?.toFixed(2) || 'â€“'}</div></div>
          <div class="stat-card glass"><div class="stat-card-label">Credits Earned</div><div class="stat-card-value text-gradient">${r.totalCreditsEarned || 0}</div></div>
          <div class="stat-card glass"><div class="stat-card-label">Skills</div><div class="stat-card-value text-gradient">${r.skillsAcquired?.length || 0}</div></div>
        </div>
        ${r.skillsAcquired?.length ? `<div class="panel glass" style="margin-bottom:20px;"><div class="panel-header"><span class="panel-title">ğŸ› ï¸ Skills Acquired</span></div><div style="display:flex;flex-wrap:wrap;gap:8px;">${r.skillsAcquired.map(s => `<span class="skill-tag">${s}</span>`).join('')}</div></div>` : ''}
        <div class="panel glass">
          <div class="panel-header"><span class="panel-title">ğŸ“œ Transcript</span>${r.isVerified ? '<span class="badge" style="color:var(--success)">âœ… Verified</span>' : ''}</div>
          ${r.courseRecords?.length ? `<table class="grade-table"><thead><tr><th>Course</th><th>Code</th><th>Credits</th><th>Grade</th><th>CGPA pts</th></tr></thead><tbody>
            ${r.courseRecords.map(c => `<tr>
              <td>${c.courseName || 'â€“'}</td>
              <td style="color:var(--text-muted)">${c.courseCode || 'â€“'}</td>
              <td>${c.credits || 0}</td>
              <td><span class="grade-badge grade-${(c.letterGrade || 'F').replace('+', 'p')}">${c.letterGrade || 'â€“'}</span></td>
              <td>${c.gradePoint || 0}</td>
            </tr>`).join('')}
          </tbody></table>` : '<p style="text-align:center;color:var(--text-muted);padding:20px;">No course records yet.</p>'}
        </div>`;
            } catch (e) { el.innerHTML = `<p style="color:var(--danger)">${e.message}</p>`; }
        }

        // â”€â”€ Course Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function openCourseModal(id, encoded) {
            const c = JSON.parse(decodeURIComponent(encoded));
            document.getElementById('modalTitle').textContent = c.name;
            document.getElementById('modalBody').innerHTML = `
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;">
        <span class="course-category">${c.category || 'core'}</span>
        <span class="course-credits">â­ ${c.credits} Credits</span>
        <span class="badge">${c.level || 'degree'}</span>
      </div>
      <p style="color:var(--text-secondary);margin-bottom:20px;">${c.description}</p>
      ${c.skills?.length ? `<div style="margin-bottom:20px;"><strong style="font-size:0.85rem;">Skills: </strong><div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;">${c.skills.map(s => `<span class="skill-tag">${s}</span>`).join('')}</div></div>` : ''}
      ${c.modules?.length ? `<div><h4 style="margin-bottom:12px;">ğŸ“¦ Modules (${c.modules.length})</h4><div class="modules-list">${c.modules.sort((a, b) => a.order - b.order).map((m, i) => `<div class="module-item"><div class="module-num">${i + 1}</div><div><strong>${m.title}</strong>${m.description ? `<p style="color:var(--text-secondary);font-size:0.85rem;margin-top:2px;">${m.description}</p>` : ''}</div></div>`).join('')}</div></div>` : ''}
      <button class="btn btn-primary btn-full" style="margin-top:24px;" onclick="enrollNow('${c._id}');closeModal()">Enroll in This Course â†’</button>`;
            document.getElementById('courseModal').classList.add('show');
        }
        function closeModal() { document.getElementById('courseModal').classList.remove('show'); }

        // Init
        loadOverview();
    </script>
</body>

</html>